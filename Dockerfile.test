FROM ruby:3.1.2 AS builder

ARG SECRET_KEY_BASE
ENV SECRET_KEY_BASE=${SECRET_KEY_BASE}
ARG PRIMARY_DB_USERNAME
ENV PRIMARY_DB_USERNAME=${PRIMARY_DB_USERNAME}
ARG PRIMARY_DB_PASSWORD
ENV PRIMARY_DB_PASSWORD=${PRIMARY_DB_PASSWORD}
ARG PRIMARY_DB_PORT
ENV PRIMARY_DB_PORT=${PRIMARY_DB_PORT}
ARG PRIMARY_DB_HOST
ENV PRIMARY_DB_HOST=${PRIMARY_DB_HOST}
ARG PRIMARY_DB_NAME
ENV PRIMARY_DB_NAME=${PRIMARY_DB_NAME}
ARG REDIS_SESSION_URL
ENV REDIS_SESSION_URL=${REDIS_SESSION_URL}
ARG REDIS_CACHE_URL
ENV REDIS_CACHE_URL=${REDIS_CACHE_URL}

RUN gem uninstall bundler
RUN gem install bundler -v 2.3.24 --no-document

WORKDIR /app
COPY Gemfile Gemfile.lock /app/

RUN bundle install

# Copy the application codes
COPY . /app/
